<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>An Introduction to the Internet of Things: Using MQTT for the Internet of Things</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png"><link rel="manifest" href="../favicons/incubator/site.webmanifest"><link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://docs.carpentries.org/resources/curriculum/lesson-life-cycle.html" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../07-mqtt-code.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      An Introduction to the Internet of Things
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            An Introduction to the Internet of Things
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr></ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  An Introduction to the Internet of Things
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 75%" class="percentage">
    75%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 75%" aria-valuenow="75" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../07-mqtt-code.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. An Introduction to the Internet of Things</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-ArduinoIDE.html">2. The Arduino IDE</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-Understanding.html">3. Understanding the code</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-connecting_sensor1.html">4. Connecting the first sensor</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-connecting_sensor2.html">5. Connecting the second sensor</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-combine-sensors.html">6. Combining the two circuits</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        7. Using MQTT for the Internet of Things
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#adding-mqtt-to-our-sketch">Adding MQTT to our sketch</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="08-subscribe.html">8. Subscribing to an MQTT topic</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr></ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/06-combine-sensors.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/08-subscribe.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/06-combine-sensors.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Combining the two
        </a>
        <a class="chapter-link float-end" href="../instructor/08-subscribe.html" rel="next">
          Next: Subscribing to an...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Using MQTT for the Internet of Things</h1>
        <p>Last updated on 2022-08-30 |

        <a href="https://github.com/CarpentriesWorkshops/Internet_of_Things/edit/main/episodes/07-mqtt-code.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 12 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>What is MQTT?</li>
<li>How does MQTT work?</li>
<li>What is an MQTT publisher?</li>
<li>What is an MQTT broker?</li>
<li>What is an MQTT subscriber?</li>
<li>What is a client?</li>
<li>What is a server?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Explain how MQTT works</li>
</ul></div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="adding-mqtt-to-our-sketch">Adding MQTT to our sketch<a class="anchor" aria-label="anchor" href="#adding-mqtt-to-our-sketch"></a></h2>
<hr class="half-width"><div class="section level3">
<h3 id="what-is-mqtt">What is MQTT?<a class="anchor" aria-label="anchor" href="#what-is-mqtt"></a></h3>
<p><a href="https://en.wikipedia.org/wiki/MQTT" class="external-link">Message Queuing
Telemetry Transport</a></p>
<p>MQTT (originally an initialism of MQ Telemetry Transport[a]) is a
lightweight, publish-subscribe, machine to machine network protocol. It
is designed for connections with remote locations that have devices with
resource constraints or limited network bandwidth.</p>
<p>There are three components to the MQTT architecture, publishers,
subscribers and a broker. Publishers are devices on the Internet of
Things that publish messages with a specific topic to a broker.
Subscribers subscribe to specific topics on the broker. When a new value
for a specific topic is published by a publisher, then all the
subscribers to that topic will receive it.</p>
<figure><img src="../fig/mqtt_architecture.png" style="width:50.0%" alt="MQTT Architecture" class="figure mx-auto d-block"><div class="figcaption">MQTT Architecture</div>
</figure><div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Discuss, with the person next to you the following:</p>
<ol style="list-style-type: decimal"><li>What kind of devices we are likely to find on the Internet of
things?</li>
<li>Who would typically publish information from such devices?</li>
<li>Who would typically subscribe to the data?</li>
</ol></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="importing-the-mqtt-library-into-the-arduino-ide">Importing the MQTT library into the Arduino IDE<a class="anchor" aria-label="anchor" href="#importing-the-mqtt-library-into-the-arduino-ide"></a></h3>
<p>To be able to enable MQTT functionality we need to add yet another
library to our Arduino IDE. As before select <code>Tools</code> on the
menu and then <code>Manage Libraries</code>. Enter
<code>PubSubClient</code> into the text box for searching. Scroll down
until you find <code>PubSubClient by Nick O'Leary</code> and click the
Install button:</p>
<figure><img src="../fig/PubSubClient.png" alt="Installing the PubSubClient library for MQTT messaging" class="figure mx-auto d-block"><div class="figcaption">Installing the PubSubClient library for MQTT
messaging</div>
</figure><p>There are three pieces of information that we will need before we
enter the code for sending and messages via MQTT:</p>
<ol style="list-style-type: decimal"><li>The <code>ssid</code> of your Internet access point</li>
<li>The password for the access point</li>
<li>The IP address or hostname of your MQTT broker</li>
</ol><p>There are several free MQTT servers available on the Internet.
Alternatively one can set up one’s own server running an MQTT broker. In
the diagrams below two alternative setups are shown. In the first case
there is an MQTT server on the Internet that devices can publish or
subscribe to. In the second case a local MQTT broker is used which has
the advantages that all network traffic can be private, it doesn’t have
to be shared to the Internet. For the purposes of this workshop for
instance we might want to set up our own server so that we are not
dependent on the Internet.</p>
<figure><img src="../fig/mqtt_internet.png" style="width:50.0%" alt="An MQTT broker on the Internet" class="figure mx-auto d-block"><div class="figcaption">An MQTT broker on the Internet</div>
</figure><figure><img src="../fig/mqtt_local_network.png" style="width:50.0%" alt="An MQTT broker on a private network" class="figure mx-auto d-block"><div class="figcaption">An MQTT broker on a private network</div>
</figure><p>In the sketch below you will have to replace the values assigned to
the variables <code>ssid</code>, <code>password</code> and
<code>mqtt_server</code>. Your instructor should provide you with the
appropriate values which will depend on the MQTT broker you are going to
use.</p>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div> Instructor Note </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p>To avoid the requirement of Internet access for this lesson it is
possible to set up and access point and MQTT broker using a Raspberry
Pi. It could be done with any available computer, really, but the RPi
makes for a simple solution that one can prepare beforehand and keep
just for this purpose. It is small and easy to take along to a
workshop.</p>
<p>This has only been tested with a RPi 4 with 2GB of RAM. Older RPis
should work.</p>
<ol style="list-style-type: decimal"><li>Using the Raspberry Pi Imager, select the Raspberry Pi OS Lite
version of the operating system.</li>
<li>Using the settinngs menu, enable SSH and configure the wireless LAN.
The settings are very much determined by your Internet connectivity and
network setup so it might be worth looking at documentation on the
Internet for your specific circumstances. Make sure you set the Wireless
LAN coutry and the locale settings.</li>
<li>Write the operating system to a micro-SD card and start up the RPi.
You should be able to ssh into the RPi at this point</li>
<li>To create an access point we will use the software developed by the
open-source project RaspAP (<a href="https://raspap.com/" class="external-link uri">https://raspap.com/</a>)</li>
<li>To install RaspAP:</li>
</ol><div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">sudo</span> apt-get update</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">sudo</span> apt-get full-upgrade</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">sudo</span> reboot</span></code></pre>
</div>
<p>After the reboot log into the RPi again</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-sL</span> https://install.raspap.com <span class="kw">|</span> <span class="fu">bash</span></span></code></pre>
</div>
<ol start="6" style="list-style-type: decimal"><li>You should now be able to connect to the Access point with the
following information:</li>
</ol><pre><code>    IP address: 10.3.141.1
    Username: admin
    Password: secret
    DHCP range: 10.3.141.50 — 10.3.141.255
    SSID: raspi-webgui
    Password: ChangeMe</code></pre>
<ol start="7" style="list-style-type: decimal"><li>Using a browser navigate to 10.3.141.1 and log in using as user
<code>admin</code> with password <code>secret</code>. Change the IP
address to <code>192.168.0.1</code> and the DHCP range to
<code>192.168.0.50 - 192.168.0.255</code>. You don’t have to do this but
if you don’t you’ll have to adapt the IP address for the MQTT server in
the lesson.</li>
<li>Reboot the RPi</li>
<li>Log into the RPi again. We now have to install Mosquitto which is
the MQTT broker and client</li>
<li>In the terminal type the following command:</li>
</ol><div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> mosquitto mosquitto-clients</span></code></pre>
</div>
<ol start="11" style="list-style-type: decimal"><li>Reboot again just to be sure</li>
<li>Your RPi should now be running RaspAP for students to connect to for
an Access Point and it should be running the Mosquitto broker.</li>
</ol></div>
</div>
</div>
</div>
<p>For now we will continue as if your instructor has set up a local
network that includes an access point to which your computer has to
connect and an MQTT broker. You might, or might not, be connected to the
Internet once you connect to the access point, but that won’t
matter.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">C<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode c" tabindex="0"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;DHT.h&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;WiFi.h&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;PubSubClient.h&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="pp">#define DHT_SENSOR_TYPE DHT22</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="pp">#define DHT_SENSOR_PIN </span><span class="dv">32</span><span class="pp"> </span><span class="co">// ESP32 pin connected to DHT sensor</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="pp">#define LIGHT_SENSOR_PIN </span><span class="dv">36</span><span class="pp"> </span><span class="co">// ESP32 pin GIOP36 (ADC0)</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="dt">const</span> <span class="dt">int</span> readingdelay <span class="op">=</span> <span class="dv">3000</span><span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> ssid <span class="op">=</span> <span class="st">"raspi-webgui"</span><span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> password <span class="op">=</span> <span class="st">"ChangeMe"</span><span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> mqtt_server <span class="op">=</span> <span class="st">"192.168.0.1"</span><span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="dt">const</span> String your_name <span class="op">=</span> <span class="st">"/JohnSmith"</span><span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>DHT dht_sensor<span class="op">(</span>DHT_SENSOR_PIN<span class="op">,</span> DHT_SENSOR_TYPE<span class="op">);</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>WiFiClient espClient<span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>PubSubClient client<span class="op">(</span>espClient<span class="op">);</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>String topic_temperature <span class="op">=</span> your_name <span class="op">+</span> <span class="st">"/dht22/temperature"</span><span class="op">;</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>String topic_light <span class="op">=</span> your_name <span class="op">+</span> <span class="st">"/ldr/light/"</span><span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>  Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">9600</span><span class="op">);</span> <span class="co">// initialize serial</span></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span>F<span class="op">(</span><span class="st">"Starting ..."</span><span class="op">));</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>  dht_sensor<span class="op">.</span>begin<span class="op">();</span> <span class="co">// initialize the DHT sensor</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>  setup_wifi<span class="op">();</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>  client<span class="op">.</span>setServer<span class="op">(</span>mqtt_server<span class="op">,</span> <span class="dv">1883</span><span class="op">);</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>  client<span class="op">.</span>setCallback<span class="op">(</span>callback<span class="op">);</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>client<span class="op">.</span>connected<span class="op">())</span> <span class="op">{</span></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>    reconnect<span class="op">();</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>  client<span class="op">.</span>loop<span class="op">();</span></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>  <span class="dt">float</span> temperature <span class="op">=</span> dht_sensor<span class="op">.</span>readTemperature<span class="op">();</span>   <span class="co">// read temperature in Celsius</span></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>  <span class="dt">int</span> lightlevel <span class="op">=</span> analogRead<span class="op">(</span>LIGHT_SENSOR_PIN<span class="op">);</span>     <span class="co">// read light level</span></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>isnan<span class="op">(</span>temperature<span class="op">))</span> <span class="op">{</span></span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"Failed to read from DHT sensor!"</span><span class="op">);</span></span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>    <span class="co">/* When reading the temperature and light levels, we get the values</span></span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a><span class="co">       as numbers, but when we send it to the MQTT broker the values</span></span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a><span class="co">       have to be converted to strings. We therefore have to declare</span></span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a><span class="co">       variables of type char into which the number values can be transferred</span></span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a>    <span class="dt">char</span> tempString<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a>    <span class="dt">char</span> lightString<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb5-55"><a href="#cb5-55" tabindex="-1"></a><span class="co">     * Transfer the number values into strings</span></span>
<span id="cb5-56"><a href="#cb5-56" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb5-57"><a href="#cb5-57" tabindex="-1"></a>    dtostrf<span class="op">(</span>temperature<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> tempString<span class="op">);</span></span>
<span id="cb5-58"><a href="#cb5-58" tabindex="-1"></a>    dtostrf<span class="op">(</span>lightlevel<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> lightString<span class="op">);</span></span>
<span id="cb5-59"><a href="#cb5-59" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" tabindex="-1"></a>    <span class="co">// Print the temperature to the monitor</span></span>
<span id="cb5-61"><a href="#cb5-61" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Temperature: "</span><span class="op">);</span></span>
<span id="cb5-62"><a href="#cb5-62" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span>temperature<span class="op">);</span></span>
<span id="cb5-63"><a href="#cb5-63" tabindex="-1"></a>    <span class="co">// Publish the temperature to the MQTT broker</span></span>
<span id="cb5-64"><a href="#cb5-64" tabindex="-1"></a>    publishMQTT<span class="op">(</span>topic_temperature<span class="op">,</span> tempString<span class="op">);</span></span>
<span id="cb5-65"><a href="#cb5-65" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" tabindex="-1"></a>    <span class="co">// Print the light level to the monitor</span></span>
<span id="cb5-67"><a href="#cb5-67" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Light: "</span><span class="op">);</span></span>
<span id="cb5-68"><a href="#cb5-68" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span>lightlevel<span class="op">);</span></span>
<span id="cb5-69"><a href="#cb5-69" tabindex="-1"></a>    <span class="co">// Publish the light level to the MQTT broker</span></span>
<span id="cb5-70"><a href="#cb5-70" tabindex="-1"></a>    publishMQTT<span class="op">(</span>topic_light<span class="op">,</span> lightString<span class="op">);</span></span>
<span id="cb5-71"><a href="#cb5-71" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" tabindex="-1"></a>    <span class="co">// wait a 3 seconds between readings</span></span>
<span id="cb5-73"><a href="#cb5-73" tabindex="-1"></a>    delay<span class="op">(</span>readingdelay<span class="op">);</span></span>
<span id="cb5-74"><a href="#cb5-74" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-75"><a href="#cb5-75" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-76"><a href="#cb5-76" tabindex="-1"></a></span>
<span id="cb5-77"><a href="#cb5-77" tabindex="-1"></a><span class="dt">void</span> setup_wifi<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-78"><a href="#cb5-78" tabindex="-1"></a>  delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb5-79"><a href="#cb5-79" tabindex="-1"></a>  <span class="co">// We start by connecting to a WiFi network</span></span>
<span id="cb5-80"><a href="#cb5-80" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">();</span></span>
<span id="cb5-81"><a href="#cb5-81" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Connecting to "</span><span class="op">);</span></span>
<span id="cb5-82"><a href="#cb5-82" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span>ssid<span class="op">);</span></span>
<span id="cb5-83"><a href="#cb5-83" tabindex="-1"></a></span>
<span id="cb5-84"><a href="#cb5-84" tabindex="-1"></a>  WiFi<span class="op">.</span>begin<span class="op">(</span>ssid<span class="op">,</span> password<span class="op">);</span></span>
<span id="cb5-85"><a href="#cb5-85" tabindex="-1"></a></span>
<span id="cb5-86"><a href="#cb5-86" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>WiFi<span class="op">.</span>status<span class="op">()</span> <span class="op">!=</span> WL_CONNECTED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-87"><a href="#cb5-87" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb5-88"><a href="#cb5-88" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"."</span><span class="op">);</span></span>
<span id="cb5-89"><a href="#cb5-89" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-90"><a href="#cb5-90" tabindex="-1"></a></span>
<span id="cb5-91"><a href="#cb5-91" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">""</span><span class="op">);</span></span>
<span id="cb5-92"><a href="#cb5-92" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"WiFi connected"</span><span class="op">);</span></span>
<span id="cb5-93"><a href="#cb5-93" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"IP address: "</span><span class="op">);</span></span>
<span id="cb5-94"><a href="#cb5-94" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span>WiFi<span class="op">.</span>localIP<span class="op">());</span></span>
<span id="cb5-95"><a href="#cb5-95" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-96"><a href="#cb5-96" tabindex="-1"></a></span>
<span id="cb5-97"><a href="#cb5-97" tabindex="-1"></a><span class="dt">void</span> callback<span class="op">(</span><span class="dt">char</span><span class="op">*</span> topic<span class="op">,</span> byte <span class="op">*</span> message<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-98"><a href="#cb5-98" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Message arrived on topic: "</span><span class="op">);</span></span>
<span id="cb5-99"><a href="#cb5-99" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span>topic<span class="op">);</span></span>
<span id="cb5-100"><a href="#cb5-100" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">". Message: "</span><span class="op">);</span></span>
<span id="cb5-101"><a href="#cb5-101" tabindex="-1"></a>  String messageTemp<span class="op">;</span></span>
<span id="cb5-102"><a href="#cb5-102" tabindex="-1"></a></span>
<span id="cb5-103"><a href="#cb5-103" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb5-104"><a href="#cb5-104" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">((</span><span class="dt">char</span><span class="op">)</span>message<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb5-105"><a href="#cb5-105" tabindex="-1"></a>    messageTemp <span class="op">+=</span> <span class="op">(</span><span class="dt">char</span><span class="op">)</span>message<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb5-106"><a href="#cb5-106" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-107"><a href="#cb5-107" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">();</span></span>
<span id="cb5-108"><a href="#cb5-108" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-109"><a href="#cb5-109" tabindex="-1"></a></span>
<span id="cb5-110"><a href="#cb5-110" tabindex="-1"></a><span class="dt">void</span> reconnect<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-111"><a href="#cb5-111" tabindex="-1"></a>  <span class="co">// Loop until we're reconnected</span></span>
<span id="cb5-112"><a href="#cb5-112" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(!</span>client<span class="op">.</span>connected<span class="op">())</span> <span class="op">{</span></span>
<span id="cb5-113"><a href="#cb5-113" tabindex="-1"></a>    <span class="co">// Create a random client ID</span></span>
<span id="cb5-114"><a href="#cb5-114" tabindex="-1"></a>    String clientId <span class="op">=</span> <span class="st">"ESP32Client-"</span><span class="op">;</span></span>
<span id="cb5-115"><a href="#cb5-115" tabindex="-1"></a>    clientId <span class="op">+=</span> String<span class="op">(</span>random<span class="op">(</span><span class="bn">0xffff</span><span class="op">),</span> HEX<span class="op">);</span></span>
<span id="cb5-116"><a href="#cb5-116" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span>clientId <span class="op">+</span> <span class="st">" attempting MQTT connection..."</span><span class="op">);</span></span>
<span id="cb5-117"><a href="#cb5-117" tabindex="-1"></a>    <span class="co">// Attempt to connect</span></span>
<span id="cb5-118"><a href="#cb5-118" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>client<span class="op">.</span>connect<span class="op">(</span>clientId<span class="op">.</span>c_str<span class="op">(),</span> <span class="st">"jannetta"</span><span class="op">,</span> <span class="st">"f0r3v3rl1n8x"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb5-119"><a href="#cb5-119" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"connected"</span><span class="op">);</span></span>
<span id="cb5-120"><a href="#cb5-120" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb5-121"><a href="#cb5-121" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"failed, rc="</span><span class="op">);</span></span>
<span id="cb5-122"><a href="#cb5-122" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span>client<span class="op">.</span>state<span class="op">());</span></span>
<span id="cb5-123"><a href="#cb5-123" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">" try again in 5 seconds"</span><span class="op">);</span></span>
<span id="cb5-124"><a href="#cb5-124" tabindex="-1"></a>      <span class="co">// Wait 5 seconds before retrying</span></span>
<span id="cb5-125"><a href="#cb5-125" tabindex="-1"></a>      delay<span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb5-126"><a href="#cb5-126" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-127"><a href="#cb5-127" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-128"><a href="#cb5-128" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-129"><a href="#cb5-129" tabindex="-1"></a></span>
<span id="cb5-130"><a href="#cb5-130" tabindex="-1"></a><span class="dt">void</span> publishMQTT<span class="op">(</span>String topicString<span class="op">,</span> <span class="dt">char</span> payload<span class="op">[</span><span class="dv">8</span><span class="op">])</span> <span class="op">{</span></span>
<span id="cb5-131"><a href="#cb5-131" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">int</span> length <span class="op">=</span> topicString<span class="op">.</span>length<span class="op">()</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-132"><a href="#cb5-132" tabindex="-1"></a>  <span class="dt">char</span> topic<span class="op">[</span>length<span class="op">];</span></span>
<span id="cb5-133"><a href="#cb5-133" tabindex="-1"></a>  topicString<span class="op">.</span>toCharArray<span class="op">(</span>topic<span class="op">,</span> length<span class="op">);</span></span>
<span id="cb5-134"><a href="#cb5-134" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span>topic<span class="op">);</span></span>
<span id="cb5-135"><a href="#cb5-135" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">": "</span><span class="op">);</span></span>
<span id="cb5-136"><a href="#cb5-136" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span>payload<span class="op">);</span></span>
<span id="cb5-137"><a href="#cb5-137" tabindex="-1"></a>  client<span class="op">.</span>publish<span class="op">(</span>topic<span class="op">,</span> payload<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb5-138"><a href="#cb5-138" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-139"><a href="#cb5-139" tabindex="-1"></a></span>
<span id="cb5-140"><a href="#cb5-140" tabindex="-1"></a>String byteArrayToString<span class="op">(</span>byte <span class="op">*</span> byteArray<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-141"><a href="#cb5-141" tabindex="-1"></a>  String messageTemp<span class="op">;</span></span>
<span id="cb5-142"><a href="#cb5-142" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb5-143"><a href="#cb5-143" tabindex="-1"></a>    messageTemp <span class="op">+=</span> <span class="op">(</span><span class="dt">char</span><span class="op">)</span>byteArray<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb5-144"><a href="#cb5-144" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-145"><a href="#cb5-145" tabindex="-1"></a>  <span class="cf">return</span> messageTemp<span class="op">;</span></span>
<span id="cb5-146"><a href="#cb5-146" tabindex="-1"></a><span class="op">}</span></span></code></pre>
</div>
<div id="discussion2" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion</h3>
<div class="callout-content">
<p>Explanation of the code</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul><li>Keypoint</li>
</ul></div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
<ul><li><a href="https://www.arduino.cc/en/software" class="external-link">Downloading and
installing the Arduino IDE</a></li>
<li><a href="https://randomnerdtutorials.com/complete-guide-for-dht11dht22-humidity-and-temperature-sensor-with-arduino/" class="external-link">DHT11/DHT12
Guide</a></li>
<li><a href="https://arduinomodules.info/" class="external-link">Specifications and Fritzing
component downloads</a></li>
</ul></div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/06-combine-sensors.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/08-subscribe.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/06-combine-sensors.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Combining the two
        </a>
        <a class="chapter-link float-end" href="../instructor/08-subscribe.html" rel="next">
          Next: Subscribing to an...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/CarpentriesWorkshops/Internet_of_Things/edit/main/episodes/07-mqtt-code.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/CarpentriesWorkshops/Internet_of_Things/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/CarpentriesWorkshops/Internet_of_Things/" class="external-link">Source</a></p>
				<p><a href="https://github.com/CarpentriesWorkshops/Internet_of_Things/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:jannetta.steyn@newcastle.ac.uk">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.12" class="external-link">sandpaper (0.16.12)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.6" class="external-link">varnish (1.0.6)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://CarpentriesWorkshops.github.io/Internet_of_Things/instructor/07-mqtt-code.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "IoT, Internet of Things, Arduino, ESP32",
  "name": "Using MQTT for the Internet of Things",
  "creativeWorkStatus": "active",
  "url": "https://CarpentriesWorkshops.github.io/Internet_of_Things/instructor/07-mqtt-code.html",
  "identifier": "https://CarpentriesWorkshops.github.io/Internet_of_Things/instructor/07-mqtt-code.html",
  "dateCreated": "2025-04-09",
  "dateModified": "2022-08-30",
  "datePublished": "2025-06-10"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

